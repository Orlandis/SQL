use [WH]
--select * from wh.dbo.erp_ec_spec_doc_table where date_from_id = '20191205' and date_to_id = '20191218'
--select top 10 * from WH.dbo.fact_DocCash
declare @startDate int = 20191205
declare @endDate int = 20191218

IF OBJECT_ID(N'tempdb..#CustomCountChecks', N'U') IS NOT NULL
DROP TABLE #CustomCountChecks
IF OBJECT_ID(N'tempdb..#GlobCountChecks', N'U') IS NOT NULL
DROP TABLE #GlobCountChecks
IF OBJECT_ID(N'tempdb..#SKUInto', N'U') IS NOT NULL
DROP TABLE #SKUInto

create table #SKUInto (sku int)
insert into #SKUInto values (2008),
(2038),
(2039),
(5113),
(6096),
(6119),
(7885),
(10371),
(10373),
(11458),
(11470),
(12986),
(12990),
(12991),
(12996),
(13058),
(13102),
(13983),
(14595),
(15406),
(16062),
(19534),
(19597),
(20190),
(23237),
(23238),
(26024),
(26874),
(28591),
(29320),
(31403),
(36805),
(38063),
(40727),
(40817),
(40819),
(50070),
(52149),
(53206),
(53397),
(55537),
(66179),
(66272),
(77570),
(82401),
(97560),
(97562),
(97563),
(101905),
(102710),
(105412),
(105414),
(106830),
(115192),
(116336),
(119801),
(119802),
(127082),
(127083),
(127084),
(129636),
(142620),
(144671),
(147100),
(149818),
(149973),
(160271),
(160829),
(160830),
(160832),
(160834),
(165575),
(165994),
(165995),
(165996),
(166169),
(172418),
(177769),
(179253),
(181710),
(181844),
(182825),
(183151),
(184816),
(184817),
(184818),
(186023),
(190121),
(193415),
(193677),
(193682),
(196137),
(196926),
(197985),
(197988),
(200691),
(201770),
(201771),
(201944),
(202181),
(204063),
(204065),
(204145),
(206269),
(206321),
(206464),
(206515),
(206522),
(206523),
(206524),
(206525),
(206527),
(206528),
(207175),
(207908),
(208281),
(208282),
(211363),
(211365),
(211404),
(215718),
(216236),
(216489),
(216942),
(216943),
(216944),
(216945),
(216946),
(217317),
(217318),
(218087),
(218841),
(219288),
(219291),
(220743),
(221291),
(221666),
(222398),
(225383),
(226410),
(226488),
(226554),
(227465),
(227466),
(228046),
(228047),
(229107),
(229532),
(230117),
(230205),
(230210),
(230211),
(230421),
(231744),
(233100),
(233105),
(233356),
(233357),
(233359),
(233522),
(234841),
(234842),
(235329),
(235330),
(235331),
(236768),
(237857),
(237859),
(237860),
(238079),
(238166),
(238174),
(239447),
(239533),
(239641),
(239642),
(239643),
(239652),
(239663),
(240962),
(241270),
(241271),
(242310),
(242311),
(243843),
(245071),
(245075),
(245093),
(245315),
(246536),
(247201),
(247482),
(247483),
(247803),
(248276),
(248644),
(249554),
(249555),
(249709),
(250368),
(250372),
(250374),
(250631),
(251271),
(251281),
(251282),
(251283),
(251284),
(252107),
(252108),
(252109),
(252110),
(254159),
(255840),
(255842),
(255845),
(255846),
(256492),
(256494),
(256497),
(256498),
(257029),
(257031),
(257032),
(257097),
(257627),
(257668),
(257672),
(257676),
(258046),
(258664),
(259492),
(260265),
(260393),
(260965),
(262373),
(263082),
(264022),
(264066),
(265446),
(265506),
(265781),
(266105),
(266248),
(267076),
(267833),
(267838),
(267841),
(268090),
(268094),
(268623),
(268830),
(268855),
(271533),
(271902),
(271903),
(271955),
(271957),
(273154),
(273754),
(273755),
(273760),
(273761),
(273762),
(273805),
(273806),
(273950),
(274922),
(275015),
(275328),
(275857),
(275858),
(275859),
(275860),
(276036),
(276053),
(276801),
(276840),
(276841),
(276842),
(276972),
(277368),
(277369),
(277374),
(277385),
(278717),
(278718),
(278719),
(279224),
(279302),
(279303),
(279304),
(279305),
(280187),
(280389),
(280390),
(280391),
(280889),
(280891),
(282647),
(283029),
(283030),
(283086),
(283558),
(283699),
(284555),
(284621),
(284657),
(285382),
(285383),
(285494),
(285495),
(285496),
(285511),
(285513),
(285515),
(286069),
(286070),
(286071),
(286842),
(286949),
(287630),
(288480),
(288622),
(288623),
(289184),
(290145),
(290647),
(290746),
(290748),
(290749),
(290750),
(290793),
(291167),
(291325),
(291326),
(291327),
(291347),
(291415),
(291418),
(291778),
(291779),
(291820),
(291821),
(291835),
(292080),
(292081),
(292082),
(292083),
(292097),
(292098),
(292099),
(292234),
(292239),
(292708),
(293164),
(293733),
(293734),
(294388),
(294389),
(294452),
(294453),
(294707),
(294708),
(294814),
(295000),
(295003),
(295100),
(295301),
(295302),
(295699),
(297801),
(297802),
(297803),
(301422),
(303013),
(303014),
(303223),
(304171),
(304172),
(308069),
(308286),
(308289),
(309331),
(309603),
(309654),
(310525),
(312244),
(312276),
(312316),
(313271),
(313272),
(313290),
(313291),
(314055),
(314056),
(314653),
(314766),
(314883),
(315060),
(315186),
(315224),
(315225),
(315354),
(315355),
(315356),
(315634),
(315635),
(316080),
(316202),
(316546),
(316804),
(316805),
(316806),
(316807),
(316818),
(316821),
(317335),
(317447),
(317554),
(317555),
(317557),
(317684),
(317786),
(317787),
(317788),
(317800),
(317812),
(317967),
(317968),
(317979),
(317984),
(317986),
(318052),
(318154),
(318155),
(318299),
(318767),
(318768),
(318770),
(318771),
(318780),
(318786),
(318787),
(318793),
(318795),
(318797),
(318821),
(318822),
(318845),
(318854),
(318855),
(319188),
(319209),
(319210),
(319435),
(319534),
(319535),
(319669),
(319670),
(319803),
(319965),
(320000),
(274163) 


--Общее количество чеков --Временная таблица
create table #GlobCountChecks (dateBuy int, node int, nameShop varchar(255), kasID smallInt, count_position Int)
insert into #GlobCountChecks
select [fDC].[date_ID], [fDC].[node_ID], [dn].[name], [fDC].[kassa_ID], count(distinct check_num) count_all_checks 
from [wh].[dbo].[fact_DocCash] fDC join [dbo].[dim_node] dn on [fDC].[node_ID] = [dn].[node_ID] 
where [fDC].[date_ID] Between @startDate AND @endDate and [oper_type_ID] in (150401,150404) and fDC.node_ID = 299
--------and tovar_ID in (select tovar_ID from wh.dbo.erp_ec_spec_doc_table where fDC.node_ID = node_id and fDC.date_ID between date_from_id and date_to_id)
group by fDC.date_ID, fDC.node_ID, dn.name, fDC.kassa_ID order by fDC.node_ID, dn.name, fDC.kassa_ID, fDC.date_ID


--Отобранное количество чеков по категориям акции --Временная таблица
create table #CustomCountChecks (checkN int, dateBuy int, node int, nameShop varchar(255), kasID smallInt, count_position smallInt)
insert into #CustomCountChecks 
select distinct check_num count_all_checks, [fDC].[date_ID], [fDC].[node_ID], [dn].[name], [fDC].[kassa_ID], COUNT(tovar_ID)
from [wh].[dbo].[fact_DocCash] fDC join [dbo].[dim_node] dn on [fDC].[node_ID] = [dn].[node_ID] 
where [fDC].[date_ID] Between @startDate AND @endDate and [oper_type_ID] in (150401,150404) and fDC.node_ID = 299
--and tovar_ID in (select tovar_ID from wh.dbo.erp_ec_spec_doc_table erc where erc.node_id = fDC.node_ID and erc.date_from_id >= @startDate and erc.date_to_id <= @endDate)
and tovar_ID in (select sku from #SKUInto)
group by fDC.date_ID, fDC.node_ID, dn.name, fDC.kassa_ID, fDC.check_num order by fDC.node_ID, dn.name, fDC.kassa_ID, fDC.date_ID;

--select * from #SKUInto
--  Залилось

--Получение итоговых данных
--select dateBuy, node, nameShop, kasID, count_position from  #GlobCountChecks
--group by dateBuy, node, nameShop, kasID, count_position order by node, nameShop, kasID, dateBuy;
--
--select dateBuy, node, nameShop, kasID, count(count_position) onePosition from #CustomCountChecks
--where count_position = 1
--group by dateBuy, node, nameShop, kasID order by node, nameShop, kasID, dateBuy;
--
--select dateBuy, node, nameShop, kasID, count(count_position) morePosition from #CustomCountChecks
--where count_position >= 2
--group by dateBuy, node, nameShop, kasID order by node, nameShop, kasID, dateBuy;
--********************************************************************************************************
with Result1 as (select dateBuy, node, nameShop, kasID, count_position from  #GlobCountChecks
group by dateBuy, node, nameShop, kasID, count_position),

Result2 as (select dateBuy, node, nameShop, kasID, count(count_position) onePosition from #CustomCountChecks
where count_position = 1 group by dateBuy, node, nameShop, kasID),

Result3 as (select Result1.*, onePosition from Result1, Result2 where Result1.dateBuy = Result2.dateBuy AND 
Result1.node = Result2.node AND Result1.kasID = Result2.kasID),

Result4 as (select dateBuy, node, nameShop, kasID, count(count_position) morePosition from #CustomCountChecks
where count_position >= 2 group by dateBuy, node, nameShop, kasID),

Result5 as (select Result3.*, morePosition from Result3, Result4 where Result3.dateBuy = Result4.dateBuy AND 
Result3.node = Result4.node AND Result3.kasID = Result4.kasID)

select dateBuy, node, nameShop, kasID, count_position, (count_position - (onePosition + morePosition)) ZERO, 
onePosition, morePosition as '>2' --, (((onePosition + morePosition) / count_position) * 100)
from Result5 order by node, nameShop, kasID, dateBuy;









